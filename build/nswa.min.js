class SourceInstance{static LISTENER_PLAY=0;static DEFAULT_PANNER_ATTRIBUTES={coneInnerAngle:360,coneOuterAngle:360,coneOuterGain:0,distanceModel:"inverse",maxDistance:1e4,panningModel:"HRTF",refDistance:100,rolloffFactor:100};_connectedBuffer;_source;_bufferInstance;_playing;_sourceLoadedCallback;_gainNode;_pannerNode;_playbackRate;_loop;_lastRateChangeTime;_previousAccumulatedTime;_listeners;_onceListeners;constructor(e){this._connectedBuffer=!1,this._source=e,this._bufferInstance=null,this._playing=!1,this._sourceLoadedCallback=null,this._gainNode=null,this._pannerNode=null,this._playbackRate=1,this._loop=e.getLoop(),this._lastRateChangeTime=0,this._previousAccumulatedTime=0,this._listeners={},this._onceListeners={};const t=e.getVolume();1!==t&&this.setVolume(t),this._source.isReady()&&this._connect()}play(e){return this._lastRateChangeTime||(this._lastRateChangeTime=Date.now(),this._previousAccumulatedTime=1e3*(e??0),this._source.isReady()&&!this._connectedBuffer&&this._connect(),this._connectedBuffer?this._play():this._connectedBuffer||this._sourceLoadedCallback||(this._sourceLoadedCallback=this._onSourceLoaded.bind(this),this._source.addEventListener(Source.LISTENER_READY,this._sourceLoadedCallback))),this}stop(){return this._lastRateChangeTime=0,this._previousAccumulatedTime=0,this._sourceLoadedCallback&&(this._source.removeEventListener(Source.LISTENER_READY,this._sourceLoadedCallback),this._sourceLoadedCallback=null),this._playing&&(this._playing=!1,this._bufferInstance.stop()),this._connectedBuffer&&this._disconnect(),this}isPlaying(){return this._playing}setPannerAttributes(e){return this._pannerNode||this._createPannerNode(),e.coneInnerAngle!==undefined&&(this._pannerNode.coneInnerAngle=e.coneInnerAngle),e.coneOuterAngle!==undefined&&(this._pannerNode.coneOuterAngle=e.coneOuterAngle),e.coneOuterGain!==undefined&&(this._pannerNode.coneOuterGain=e.coneOuterGain),e.distanceModel!==undefined&&(this._pannerNode.distanceModel=e.distanceModel),e.maxDistance!==undefined&&(this._pannerNode.maxDistance=e.maxDistance),e.panningModel!==undefined&&(this._pannerNode.panningModel=e.panningModel),e.refDistance!==undefined&&(this._pannerNode.refDistance=e.refDistance),e.rolloffFactor!==undefined&&(this._pannerNode.rolloffFactor=e.rolloffFactor),this}setPannerPosition(e,t,n){return this._pannerNode||this._createPannerNode(),this._pannerNode.positionX.value=e,this._pannerNode.positionY.value=t,this._pannerNode.positionZ.value=n,this}setPannerOrientation(e,t,n){return this._pannerNode||this._createPannerNode(),this._pannerNode.orientationX.value=e,this._pannerNode.orientationY.value=t,this._pannerNode.orientationZ.value=n,this}removePanner(){return this._pannerNode?(this._pannerNode.disconnect(),this._pannerNode=null,this._gainNode?(this._gainNode.disconnect(),this._gainNode.connect(NSWA.destination)):(this._bufferInstance.disconnect(),this._bufferInstance.connect(NSWA.destination)),this):this}getCurrentTime(){return 0===this._lastRateChangeTime?0:((Date.now()-this._lastRateChangeTime)*this._playbackRate+this._previousAccumulatedTime)/1e3}seek(e){return this.stop(),this.play(e),this}getRate(){return this._playbackRate}setRate(e){if(this._playbackRate===e)return this;const t=Date.now(),n=t-this._lastRateChangeTime;return this._previousAccumulatedTime+=n*this._playbackRate,this._lastRateChangeTime=t,this._playbackRate=e,this._bufferInstance&&(this._bufferInstance.playbackRate.value=e),this}getLoop(){return this._loop}setLoop(e){this._loop!==e&&this._connectedBuffer&&(this._bufferInstance.loop=e)}getVolume(){return this._gainNode?this._gainNode.gain.value:1}setVolume(e){return this._gainNode||this._createGainNode(),this._gainNode.gain.setValueAtTime(e,NSWA.context.currentTime),this}destroy(){this.stop()}addEventListener(e,t,n){switch(e){case SourceInstance.LISTENER_PLAY:if(this.isPlaying())return void t();break;default:return void console.error("Received unknown listener type.",e)}n?(this._onceListeners[e]||(this._onceListeners[e]=[]),this._onceListeners[e].push(t)):(this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push(t))}removeEventListener(e,t,n){if(n){if(!this._onceListeners[e])return;const n=this._onceListeners[e].indexOf(t);n>=0&&(NSWA._removeArray(this._onceListeners[e],n),0===this._onceListeners[e].length&&delete this._onceListeners[e])}else{if(!this._listeners[e])return;const n=this._listeners[e].indexOf(t);n>=0&&(NSWA._removeArray(this._listeners[e],n),0===this._listeners[e].length&&delete this._listeners[e])}}_onEvent(e){if(this._listeners[e]){const t=this._listeners[e];for(let e=t.length-1;e>=0;e--)t[e]()}if(this._onceListeners[e]){const t=this._onceListeners[e];for(let e=t.length-1;e>=0;e--)t[e]();delete this._onceListeners[e]}}_play(){this._playing||this._connectedBuffer&&(this._playing=!0,this._bufferInstance.start(0,this.getCurrentTime()),this._onEvent(SourceInstance.LISTENER_PLAY))}_createPannerNode(){this._pannerNode||(this._pannerNode=NSWA.context.createPanner(),this._pannerNode.coneInnerAngle=SourceInstance.DEFAULT_PANNER_ATTRIBUTES.coneInnerAngle,this._pannerNode.coneOuterAngle=SourceInstance.DEFAULT_PANNER_ATTRIBUTES.coneOuterAngle,this._pannerNode.coneOuterGain=SourceInstance.DEFAULT_PANNER_ATTRIBUTES.coneOuterGain,this._pannerNode.distanceModel=SourceInstance.DEFAULT_PANNER_ATTRIBUTES.distanceModel,this._pannerNode.maxDistance=SourceInstance.DEFAULT_PANNER_ATTRIBUTES.maxDistance,this._pannerNode.panningModel=SourceInstance.DEFAULT_PANNER_ATTRIBUTES.panningModel,this._pannerNode.refDistance=SourceInstance.DEFAULT_PANNER_ATTRIBUTES.refDistance,this._pannerNode.rolloffFactor=SourceInstance.DEFAULT_PANNER_ATTRIBUTES.rolloffFactor,this._connectedBuffer&&(this._gainNode?(this._gainNode.disconnect(),this._gainNode.connect(this._pannerNode)):(this._bufferInstance.disconnect(),this._bufferInstance.connect(this._pannerNode)),this._pannerNode.connect(NSWA.destination)))}_createGainNode(){this._gainNode||(this._gainNode=NSWA.context.createGain(),this._connectedBuffer&&(this._bufferInstance.disconnect(),this._bufferInstance.connect(this._gainNode),this._pannerNode?this._gainNode.connect(this._pannerNode):this._gainNode.connect(NSWA.destination)))}_connect(){this._connectedBuffer||this._source.isReady()&&(this._connectedBuffer=!0,this._bufferInstance=NSWA.context.createBufferSource(),this._bufferInstance.buffer=this._source.getAudioBuffer(),this._bufferInstance.playbackRate.value=this._playbackRate,this._bufferInstance.loop=this._loop,this._pannerNode&&this._gainNode?(this._bufferInstance.connect(this._gainNode),this._gainNode.connect(this._pannerNode),this._pannerNode.connect(NSWA.destination)):this._gainNode?(this._bufferInstance.connect(this._gainNode),this._gainNode.connect(NSWA.destination)):this._pannerNode?(this._bufferInstance.connect(this._pannerNode),this._pannerNode.connect(NSWA.destination)):this._bufferInstance.connect(NSWA.destination))}_disconnect(){this._connectedBuffer&&(this._connectedBuffer=!1,this._bufferInstance.disconnect(),this._gainNode&&this._gainNode.disconnect(),this._pannerNode&&this._pannerNode.disconnect(),this._bufferInstance=null)}_onSourceLoaded(){this._sourceLoadedCallback&&(this._source.removeEventListener(Source.LISTENER_READY,this._sourceLoadedCallback),this._sourceLoadedCallback=null),this._connect(),this._connectedBuffer&&this._play()}}class Source{static LISTENER_READY=0;_ready;_loaded;_contextRunning;_audioBuffer;_listeners;_onceListeners;_path;_volume;_loop;constructor(e,t){this._ready=!1,this._loaded=!1,this._path=e,this._volume=t.volume??1,this._loop=t.loop??!1,this._contextRunning="running"===NSWA.context.state,this._contextRunning||NSWA.requestContextResume(this._onchangeContextState.bind(this)),this._audioBuffer=null,this._listeners={},this._onceListeners={};fetch(e).then(this._onloadResult.bind(this))}getPath(){return this._path}isReady(){return this._ready}getAudioBuffer(){return this._audioBuffer}getVolume(){return this._volume}setVolume(e){this._volume=e}getDuration(){return this._audioBuffer?this._audioBuffer.duration:0}getLoop(){return this._loop}setLoop(e){this._loop=e}create(){return new SourceInstance(this)}destroy(){throw"I don't yet have a neeed to destroy audio sources."}addEventListener(e,t,n){switch(e){case Source.LISTENER_READY:if(this._ready)return void t();break;default:return void console.error("Received unknown listener type.",e)}n?(this._onceListeners[e]||(this._onceListeners[e]=[]),this._onceListeners[e].push(t)):(this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push(t))}removeEventListener(e,t,n){if(n){if(!this._onceListeners[e])return;const n=this._onceListeners[e].indexOf(t);n>=0&&(NSWA._removeArray(this._onceListeners[e],n),0===this._onceListeners[e].length&&delete this._onceListeners[e])}else{if(!this._listeners[e])return;const n=this._listeners[e].indexOf(t);n>=0&&(NSWA._removeArray(this._listeners[e],n),0===this._listeners[e].length&&delete this._listeners[e])}}_onEvent(e){if(this._listeners[e]){const t=this._listeners[e];for(let e=t.length-1;e>=0;e--)t[e]()}if(this._onceListeners[e]){const t=this._onceListeners[e];for(let e=t.length-1;e>=0;e--)t[e]();delete this._onceListeners[e]}}_onloadResult(e){200===e.status?e.arrayBuffer().then(this._onloadArrayBuffer.bind(this)):console.error("Could not load audio source.",e.url,e.status,e.statusText)}_onloadArrayBuffer(e){NSWA.context.decodeAudioData(e).then(this._onloadAudioBuffer.bind(this))}_onloadAudioBuffer(e){this._loaded=!0,this._audioBuffer=e,this._checkReady()}_checkReady(){const e=this._loaded&&this._contextRunning;!this._ready&&e&&(this._ready=!0,this._onEvent(Source.LISTENER_READY))}_onchangeContextState(){"running"===NSWA.context.state&&(this._contextRunning=!0,this._checkReady())}}const NSWA={context:new(window.AudioContext??window.webAudioContext),destination:null,Source:Source,setListenerOrientation:function(e,t,n,s,i,o){NSWA.context.listener.forwardX.value=e,NSWA.context.listener.forwardY.value=t,NSWA.context.listener.forwardZ.value=n,NSWA.context.listener.upX.value=s,NSWA.context.listener.upY.value=i,NSWA.context.listener.upZ.value=o},setListenerPosition:function(e,t,n){NSWA.context.listener.positionX.value=e,NSWA.context.listener.positionY.value=t,NSWA.context.listener.positionZ.value=n},setVolume(e){NSWA.destination.gain.setValueAtTime(e,NSWA.context.currentTime)},requestContextResume:function(e){if("running"!==NSWA.context.state){if(e){-1===NSWA._contextResumeListeners.indexOf(e)&&NSWA._contextResumeListeners.push(e)}NSWA._requestedContextResume||(NSWA._requestedContextResume=!0,NSWA.context.addEventListener("statechange",NSWA._stateChangeListener),window.addEventListener("click",NSWA._inputListener),window.addEventListener("keydown",NSWA._inputListener),window.addEventListener("touchstart",NSWA._inputListener))}else e&&e()},_requestedContextResume:!1,_contextResumeListeners:[],_removeArray:function(e,t){for(let n=t;n<e.length-1;n++)e[n]=e[n+1];e.length--},_stateChangeListener:function(){if("running"===NSWA.context.state){for(let e=0;e<NSWA._contextResumeListeners.length;e++)NSWA._contextResumeListeners[e]();NSWA._contextResumeListeners.length=0,NSWA._requestedContextResume&&(NSWA._requestedContextResume=!1,window.removeEventListener("click",NSWA._inputListener),window.removeEventListener("keydown",NSWA._inputListener),window.removeEventListener("touchstart",NSWA._inputListener))}else NSWA.requestContextResume()},_inputListener:function(){NSWA.context.resume()}};NSWA.destination=NSWA.context.createGain(),NSWA.destination.connect(NSWA.context.destination),"running"!==NSWA.context.state&&NSWA.requestContextResume();